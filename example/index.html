<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>bubbweb - bubbletea in the browser</title>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit"></script>
    <link href="https://cdn.jsdelivr.net/npm/@xterm/xterm/css/xterm.min.css" rel="stylesheet">
    <script src="wasm_exec.js"></script>
    <!-- Add Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: black;
        }
        .terminal-container {
            overflow: hidden;
            background-color: black;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .cursor {
            animation: blink 1.2s infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1.5s linear infinite;
        }
    </style>
</head>
<body class="bg-black flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-gray-900 text-white p-4 border-b border-gray-700 flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-green-400">bubbweb</h1>
            <span class="text-gray-400 text-sm">bubbletea in the browser</span>
        </div>
        <a href="https://github.com/tmc/bubbweb" target="_blank" class="flex items-center text-gray-300 hover:text-white transition-colors">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
            </svg>
            GitHub
        </a>
    </header>

    <!-- Loading indicator -->
    <div id="loading-indicator" class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-black bg-opacity-90">
        <div class="flex flex-col items-center space-y-6">
            <div class="spinner text-green-400">
                <svg class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div class="font-mono text-green-400 text-center">
                <div class="text-lg mb-2">Loading bubbweb...</div>
                <div class="text-sm flex items-center justify-center">
                    <span id="loading-message">Initializing WASM</span><span class="cursor ml-1">_</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="terminal-container flex-grow">
        <div id="terminal" class="h-full"></div>
    </div>

    <!-- Update notification using Tailwind classes -->
    <div id="update-notification" 
         class="fixed bottom-5 right-5 bg-black bg-opacity-80 text-green-400 border border-green-400 rounded px-4 py-2 font-mono text-sm z-50 opacity-0 transform translate-y-5 transition-all duration-300 cursor-pointer shadow-lg shadow-green-400/30 hover:bg-black hover:shadow-green-400/50"
         onclick="window.location.reload()">
        New version available. Click to update.
    </div>

    <script>
        // Store the last known ETag
        let lastETag = localStorage.getItem('wasmETag') || '';
        let updateCheckInterval = null;
        let updateAvailable = false;
        let loadingMessages = [
            "Initializing WASM",
            "Loading bubbletea",
            "Preparing terminal",
            "Almost ready"
        ];
        let currentMessageIndex = 0;

        // Update loading message periodically
        const messageInterval = setInterval(() => {
            currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
            document.getElementById('loading-message').textContent = loadingMessages[currentMessageIndex];
        }, 2000);

        function initTerminal() {
            // Check if bubbletea is initialized
            if (globalThis.bubbletea_resize === undefined || globalThis.bubbletea_read === undefined || globalThis.bubbletea_write === undefined) {
                setTimeout(() => {
                    console.log("waiting for bubbletea");
                    initTerminal();
                }, 500);
                return;
            }

            // Hide loading indicator with a fade out effect
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.add('transition-opacity', 'duration-500', 'opacity-0');
            setTimeout(() => {
                loadingIndicator.style.display = 'none';
                clearInterval(messageInterval);
            }, 500);

            const term = new Terminal();
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(document.getElementById('terminal'));

            // Register terminal resize
            fitAddon.fit();
            window.addEventListener('resize', () => (fitAddon.fit()));

            // Focus terminal
            term.focus();

            // Initial resize
            bubbletea_resize(term.cols, term.rows)

            // Read from bubbletea and write to xterm
            setInterval(() => {
                const read = bubbletea_read();
                if (read && read.length > 0) {
                    term.write(read);
                }
            }, 100);

            // Resize on terminal resize
            term.onResize((size) => (bubbletea_resize(size.cols, size.rows)));

            // Write xterm output to bubbletea
            term.onData((data) => (bubbletea_write(data)));
            
            // Start background update check after terminal is initialized
            setInterval(checkForUpdates, 5000);
        }

        // Function to check for updates in the background
        async function checkForUpdates() {
            if (updateAvailable) return;
            
            try {
                // Create headers object with ETag
                const headers = new Headers();
                headers.append('If-None-Match', lastETag);
                
                // Make a HEAD request to check if the WASM file has been updated
                const response = await fetch("./bubbletea.wasm", { 
                    method: 'HEAD',
                    headers: headers,
                    cache: 'no-cache'
                });
                
                // If we get a 200 response (not 304 Not Modified), there's a new version
                if (response.status === 200) {
                    const newETag = response.headers.get('ETag');
                    if (newETag && newETag !== lastETag) {
                        console.log(`New version detected. Current ETag: ${lastETag}, New ETag: ${newETag}`);
                        showUpdateNotification();
                        updateAvailable = true;
                    }
                }
            } catch (error) {
                console.error('Error checking for updates:', error);
            }
        }
        
        // Function to show the update notification
        function showUpdateNotification() {
            const notification = document.getElementById('update-notification');
            notification.classList.remove('opacity-0', 'translate-y-5');
            notification.classList.add('opacity-100', 'translate-y-0');
            
            // Add a subtle pulse animation
            let pulseCount = 0;
            const pulseInterval = setInterval(() => {
                if (pulseCount >= 3) {
                    clearInterval(pulseInterval);
                    return;
                }
                
                notification.classList.add('shadow-green-400/70');
                setTimeout(() => {
                    notification.classList.remove('shadow-green-400/70');
                }, 500);
                
                pulseCount++;
            }, 3000);
        }

        async function loadWasm(retryCount = 0) {
            const maxRetries = 10;
            const baseDelay = 1000;
            
            try {
                console.log(`Attempting to load WASM (attempt ${retryCount + 1})`);
                
                const headers = new Headers();
                if (lastETag) {
                    headers.append('If-None-Match', lastETag);
                    console.log(`Using ETag: ${lastETag}`);
                }
                
                const response = await fetch("./bubbletea.wasm", { headers });
                
                const newETag = response.headers.get('ETag');
                if (newETag) {
                    console.log(`Received new ETag: ${newETag}`);
                    lastETag = newETag;
                    localStorage.setItem('wasmETag', newETag);
                }
                
                if (response.status === 304) {
                    console.log('WASM file not modified, using cached version');
                    const cachedResponse = await fetch("./bubbletea.wasm");
                    const go = new Go();
                    const result = await WebAssembly.instantiateStreaming(cachedResponse, go.importObject);
                    go.run(result.instance).then(() => {
                        console.log("wasm finished (cached)");
                    });
                    initTerminal();
                    return true;
                }
                
                const go = new Go();
                const result = await WebAssembly.instantiateStreaming(response, go.importObject);
                
                go.run(result.instance).then(() => {
                    console.log("wasm finished");
                });

                initTerminal();
                
                return true;
            } catch (error) {
                console.error(`Failed to load WASM (attempt ${retryCount + 1}):`, error);
                
                if (retryCount < maxRetries) {
                    const delay = baseDelay * Math.pow(1.5, retryCount) * (0.9 + Math.random() * 0.2);
                    console.log(`Retrying in ${Math.round(delay / 1000)} seconds...`);
                    
                    return new Promise(resolve => {
                        setTimeout(() => {
                            resolve(loadWasm(retryCount + 1));
                        }, delay);
                    });
                } else {
                    console.error(`Failed to load WASM after ${maxRetries} attempts. Giving up.`);
                    return false;
                }
            }
        }

        function init() {
            loadWasm().then(success => {
                if (!success) {
                    console.error("Could not initialize the application. Please check your connection and reload the page.");
                    // Update loading message to show error
                    document.getElementById('loading-message').textContent = "Failed to load. Please refresh.";
                    clearInterval(messageInterval);
                }
            });
        }

        init();
    </script>
</body>
</html>